<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.1.3/dist/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <title>Document</title>
</head>

<body>
    <div class="container mt-5 overflow-hidden ">
        <div class="row gx-5 no-gutters">
            <div class="col-6 col-md-4  border ">
                <form>
                    <div class="form-group">
                        <label for="_id">Product Id</label>
                        <input type="text" readonly class="form-control" id="_id">
                    </div>
                    <div class="form-group">
                        <label for="productName">Product name</label>
                        <input type="text" class="form-control" id="productName">
                    </div>
                    <div class="form-group">
                        <label for="productQuantity">Product quantity</label>
                        <input type="text" class="form-control" id="productQuantity">
                    </div>

                    <button type="button" class="btn-primary " onclick="getProducts()">Get product</button>
                    <button type="button" class="btn-success " onclick="createProduct()">Create product</button>
                    <button type="button" class="btn-secondary btn-rounded" onclick="updateProduct()">Update
                        product</button>
                    <div id="totalProduct" class="text-center"></div>
                </form>
            </div>
            <div class="col-8 col-sm-6 col-md-8 border padding-0 ">
                <table id="table" class="table"></table>
            </div>

        </div>


    </div>

    <script>
        let apiEndPoint = "http://localhost:8888";

        let getProducts = async () => {
            let response = await fetch(apiEndPoint);
            let result = await response.json();
            window.data = result;
            drawTable(result);
        }

        let drawTable = (data) => {
            let table = `           
                    <thead>
                        <tr>
                            <th scope="col">Id</th>
                            <th scope="col">Product name</th>
                            <th scope="col">Product quantity</th>
                            <th scope="col">Avatar</th>
                            <th scope="col">Action</th>

                        </tr>
                            </thead>
                            <tbody>
                            ${data.map((data) =>
                `<tr>
                                            <th>${data._id}</th>
                                            <td>${data.productName}</td>
                                            <td>${data.productQuantity}</td>
                                            <td><img src="${data.photo}" alt=""></td>
                                            <td>
                                            <button><i class="fa fa-pencil"  onclick= "setEditProduct('${data._id}')" ></i></button> 
                                            <button><i class="fa fa-trash" onclick= "deleteProduct('${data._id}')"></i></button>
                                                </td>
                                        </tr>`
            ).join("\n")} 
                    </tbody>`
            document.getElementById('table').innerHTML = table;
            document.getElementById('totalProduct').innerHTML = `<b>Total Product is ${data.length}</b>`;
        }

        let createProduct = async () => {
            let productName = document.getElementById('productName').value;
            let productQuantity = document.getElementById('productQuantity').value;
            let newProduct = { productName, productQuantity };
            let response = await fetch(apiEndPoint, {
                method: "POST",
                body: JSON.stringify(newProduct),
                headers: {
                    "content-type": "application/json"
                }
            });

            let data = await response.json();
            window.data.push(data);
            drawTable(window.data);
            clearInput();

        };

        let clearInput = () => {
            document.getElementById('_id').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productQuantity').value = '';
        }
        window.onload = clearInput();

        //UPdate Products

        let setEditProduct = (id) => {
            let editProduct = window.data.filter(elm => elm._id == id)[0];
            document.getElementById('_id').value = editProduct._id;
            document.getElementById('productName').value = editProduct.productName;
            document.getElementById('productQuantity').value = editProduct.productQuantity;
        }

        let updateProduct = async () => {
            let _id = document.getElementById('_id').value;
            let productName = document.getElementById('productName').value;
            let productQuantity = document.getElementById('productQuantity').value;
            let newProduct = { _id, productName, productQuantity };
            let updatedProduct = await callServer(_id, 'put', newProduct);

            window.data.map(product => {
                if (product._id == updatedProduct._id) {
                    product.productName = updatedProduct.productName;
                    product.productQuantity = updatedProduct.productQuantity;
                }
                return product
            });
            drawTable(window.data);
            clearInput();
        };


        let deleteProduct = async (id) => {
            debugger;
            await callServer(id, 'delete')
            window.data = window.data.filter(elm => elm._id != id);
            drawTable(window.data);
        };

        async function callServer(endpoint, method, data) {
            var result = await fetch(`${apiEndPoint}/${endpoint}`, {
                method: method,
                body: JSON.stringify(data),
                headers: {
                    'content-type': 'application/json'
                }
            }).then(res => res.json())
                .catch(err => {
                    console.log(err);
                });

            return result;
        }

    </script>



</body>

</html>